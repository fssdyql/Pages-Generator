<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ç½‘é¡µåŠ å¯†ç”Ÿæˆå™¨</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
<style>
    :root { --p: #2563eb; --bg: #f8fafc; }
    body{font-family:"Segoe UI",sans-serif;background:var(--bg);color:#334155;margin:0;padding:20px;max-width:1200px;margin:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid #e2e8f0;margin-bottom:20px}
    h2{margin-top:0;font-size:16px;border-bottom:1px solid #f1f5f9;padding-bottom:10px;color:#0f172a;display:flex;justify-content:space-between;align-items:center}
    
    label{font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:5px}
    input[type=text],select{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;margin-bottom:10px;box-sizing:border-box}
    button{padding:8px 16px;background:var(--p);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600}
    button:hover{filter:brightness(0.9)}
    button.gray{background:#64748b}
    
    .guide-box{background:#1e293b;color:#e2e8f0;padding:15px;border-radius:8px;font-family:monospace;font-size:12px;overflow-x:auto;line-height:1.5}
    .guide-tag{color:#38bdf8;font-weight:bold}
    .guide-com{color:#94a3b8;font-style:italic}
    
    #editor-container{height:400px;border:1px solid #cbd5e1;border-radius:6px;overflow:hidden}
    .preview-iframe{width:100%;height:300px;border:none;border-radius:6px;background:#fff;border:1px solid #cbd5e1}
    
    /* æ–°å¢æ ·å¼ */
    .multi-content-item {border:1px solid #e2e8f0;border-radius:6px;padding:15px;margin-bottom:15px;background:#f8fafc}
    .multi-content-header {display:flex;justify-content:space-between;margin-bottom:10px}
    .multi-content-locks {font-size:11px;color:#64748b;margin-top:5px}
    .lock-tag {background:#e2e8f0;padding:2px 6px;border-radius:3px;margin-right:5px;display:inline-block;margin-bottom:3px}
    .file-drop-zone {border:2px dashed #cbd5e1;border-radius:6px;padding:15px;margin-bottom:10px;background:#f8fafc;text-align:center;color:#64748b}
    .file-drop-zone.dragover {border-color:#2563eb;background:#eff6ff}
</style>
</head>
<body>

<div style="margin-bottom:20px;display:flex;justify-content:space-between;align-items:center">
    <h1 style="margin:0;font-size:20px">ğŸ“¦ ç¦»çº¿ç½‘é¡µåŠ å¯†ç”Ÿæˆå™¨ <span style="font-size:12px;font-weight:normal;color:#64748b">v6.0-alpha1</span></h1>
    <div>
        <button class="gray" onclick="loadDefaultTemplate()">ğŸ”„ åŠ è½½é»˜è®¤æ¨¡æ¿</button>
        <button onclick="generate()">ğŸš€ ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶</button>
    </div>
</div>

<div class="grid">
    <!-- å·¦ä¾§ï¼šé…ç½®åŒº -->
    <div>
        <!-- 1. æ•°æ®æºä¸å¯†é’¥ -->
        <div class="card">
            <h2>1. æ•°æ®æºä¸å¯†é’¥</h2>
            
            <!-- ä¿®æ”¹ä¸»å¯†é’¥åŒºåŸŸ -->
            <label>ä¸»å¯†é’¥ (APIéªŒè¯é€šè¿‡åéœ€è¿”å›æ­¤å€¼)</label>
            <div style="display:flex;gap:10px;margin-bottom:10px">
                <input type="text" id="masterKey" style="background:#fff;color:#059669;font-weight:bold;border:1px solid #cbd5e1;border-radius:6px;padding:8px;flex:1">
                <div style="display:flex;gap:5px">
                    <button class="gray" onclick="initKey()">éšæœºç”Ÿæˆ</button>
                    <button class="gray" onclick="setCustomKey()">è‡ªå®šä¹‰</button>
                </div>
            </div>
            
            <!-- ä¿®æ”¹åŸå§‹å†…å®¹åŒºåŸŸï¼Œæ·»åŠ æ–‡ä»¶é€‰æ‹©å’Œæ‹–æ”¾ -->
            <label>åŸå§‹å†…å®¹ (LX æº HTML)</label>
            <div id="srcHtmlContainer" class="file-drop-zone" onclick="document.getElementById('srcHtmlFile').click()">
                <div>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ”¾ HTML æ–‡ä»¶åˆ°è¿™é‡Œ</div>
                <div style="font-size:12px;margin:10px 0">æˆ–ç›´æ¥åœ¨ä¸‹é¢æ–‡æœ¬æ¡†ä¸­ç²˜è´´å†…å®¹</div>
            </div>
            <textarea id="srcHtml" style="width:100%;height:80px;border:1px solid #cbd5e1;border-radius:6px;margin-bottom:10px;padding:8px;box-sizing:border-box" placeholder="åœ¨æ­¤ç²˜è´´HTMLå†…å®¹..."></textarea>
            <input type="file" id="srcHtmlFile" accept=".html,.htm" style="display:none">
        </div>

        <!-- æ–°å¢ï¼šå¤šå†…å®¹é…ç½®åŒºåŸŸ -->
        <div class="card">
            <h2 style="display:flex;justify-content:space-between;align-items:center">
                <span>2. å¤šå†…å®¹é…ç½®</span>
                <button onclick="addContent()" style="font-size:12px;padding:4px 8px">+ æ·»åŠ å†…å®¹</button>
            </h2>
            
            <div id="multiContentList">
                <!-- åŠ¨æ€æ·»åŠ çš„å†…å®¹é¡¹ -->
            </div>
        </div>

        <!-- 3. è§£é”ç­–ç•¥ -->
        <div class="card">
            <h2>3. è§£é”ç­–ç•¥é…ç½®</h2>
            
            <div style="background:#f8fafc;padding:10px;border-radius:6px;margin-bottom:10px">
                <label>
                    <input type="checkbox" id="useApi" onchange="document.getElementById('apiSet').style.display=this.checked?'block':'none'"> 
                    å¯ç”¨è¿œç¨‹ API éªŒè¯
                </label>
                <div id="apiSet" style="display:none;margin-top:10px;border-top:1px dashed #cbd5e1;padding-top:10px">
                    <input type="text" id="apiUrl" placeholder="URL: https://api.com/auth?k={KEY}">
                    <div style="display:flex;gap:5px">
                        <select id="apiType"><option value="text">çº¯æ–‡æœ¬</option><option value="json">JSON</option></select>
                        <input type="text" id="apiPath" placeholder="JSONè·¯å¾„ (å¦‚ data.key)">
                    </div>
                </div>
            </div>

            <div style="background:#f8fafc;padding:10px;border-radius:6px">
                <label>æœ¬åœ°å¤‡ç”¨å¯†é’¥ï¼ˆç”¨äºå…¨å±€è§£é”ï¼‰</label>
                <div style="display:flex;gap:5px;margin-bottom:5px">
                    <input type="text" id="txtPass" placeholder="æ·»åŠ å¯†ç ...">
                    <button onclick="addPass()">â•</button>
                </div>
                <div style="display:flex;gap:5px">
                    <input type="file" id="filePass">
                    <button class="gray" onclick="addFile()">ğŸ“‚ åŠ æ–‡ä»¶é”</button>
                </div>
                <div id="vaultList" style="margin-top:5px;font-size:12px;color:#64748b"></div>
            </div>
        </div>

        <!-- 4. å¼€å‘æŒ‡å— -->
        <div class="card">
            <h2>ğŸ“– æ¨¡æ¿ç¼–å†™æŒ‡å— (API æ–‡æ¡£)</h2>
            <div class="guide-box">
<span class="guide-com">// 1. å†…æ ¸ä¼šè‡ªåŠ¨æ³¨å…¥ window.LX å¯¹è±¡</span>
<span class="guide-tag">window.LX.unlock(password)</span>
<span class="guide-com">-> å°è¯•ä½¿ç”¨æ–‡æœ¬å¯†ç è§£é”</span>

<span class="guide-tag">window.LX.unlockWithFile(fileInputInfo)</span>
<span class="guide-com">-> ä¼ å…¥ File å¯¹è±¡æˆ– Hash å°è¯•è§£é”</span>

<span class="guide-tag">window.LX.unlockWithApi(token)</span>
<span class="guide-com">-> ä½¿ç”¨ Token è°ƒç”¨é…ç½®çš„ API è§£é”</span>

<span class="guide-tag">window.LX.onMessage = function(msg, type){}</span>
<span class="guide-com">-> è¦†ç›–æ­¤å‡½æ•°ä»¥æ¥æ”¶é”™è¯¯/çŠ¶æ€æ¶ˆæ¯</span>
<span class="guide-com">-> type: 'error' | 'info' | 'success'</span>

<span class="guide-tag">window.LX.config</span>
<span class="guide-com">-> { useApi: true/false } ç”¨äºæ§åˆ¶UIæ˜¾ç¤º</span>

<span class="guide-com">// æ–°å¢ï¼šå¤šå†…å®¹ç›¸å…³</span>
<span class="guide-tag">window.LX.contents</span>
<span class="guide-com">-> è¿”å›æ‰€æœ‰å†…å®¹çš„åç§°æ•°ç»„</span>

<span class="guide-tag">window.LX.unlockContent(index, key)</span>
<span class="guide-com">-> ç›´æ¥è§£é”ç‰¹å®šå†…å®¹</span>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šæ¨¡æ¿ç¼–è¾‘ -->
    <div>
        <div class="card" style="height:100%;display:flex;flex-direction:column;box-sizing:border-box">
            <h2>
                <span>4. è‡ªå®šä¹‰æ¨¡æ¿ (HTML)</span>
                <span style="font-size:12px;font-weight:normal;color:#64748b">å¦‚æœä¸å¡«ï¼Œåˆ™ä½¿ç”¨é»˜è®¤æš—é»‘ä¸»é¢˜</span>
            </h2>
            <div id="editor-container"></div>
            <textarea id="tplInput" style="display:none"></textarea>
            
            <h2 style="margin-top:20px">é¢„è§ˆ (ä»…ä¾› UI å‚è€ƒ)</h2>
            <iframe id="previewFrame" class="preview-iframe"></iframe>
        </div>
    </div>
</div>

<script>
// --- é€»è¾‘å¤„ç†éƒ¨åˆ† ---
let masterKey = '';
let vault = []; // å…¨å±€è§£é”æ–¹å¼
let editor;
let multiContents = []; // å­˜å‚¨å¤šä¸ªåŸå§‹å†…å®¹

// åˆå§‹åŒ–å¤šå†…å®¹æ•°ç»„
function initMultiContents() {
    multiContents = [{
        id: Date.now(),
        name: 'é»˜è®¤å†…å®¹',
        html: '',
        passwords: [],
        files: []
    }];
    renderMultiContents();
}

// æ¸²æŸ“å¤šå†…å®¹åˆ—è¡¨
function renderMultiContents() {
    const container = document.getElementById('multiContentList');
    container.innerHTML = multiContents.map(content => `
        <div class="multi-content-item">
            <div class="multi-content-header">
                <input type="text" value="${content.name}" 
                       onchange="updateContentName(${content.id}, this.value)"
                       style="border:none;background:none;font-weight:bold;color:#0f172a;flex:1;padding:5px">
                <button onclick="removeContent(${content.id})" class="gray" style="padding:3px 8px;font-size:11px">åˆ é™¤</button>
            </div>
            
            <label style="font-size:11px">HTML å†…å®¹</label>
            <textarea data-id="${content.id}" 
                      onchange="updateContentHtml(${content.id}, this.value)"
                      oninput="updateContentHtml(${content.id}, this.value)"
                      style="width:100%;height:60px;border:1px solid #cbd5e1;border-radius:4px;padding:6px;font-size:12px;margin-bottom:10px">${content.html}</textarea>
            
            <div style="display:flex;gap:5px;margin-bottom:5px">
                <input type="text" data-id="${content.id}" placeholder="æ·»åŠ å¯†ç ..." style="flex:1;padding:4px;font-size:12px">
                <button onclick="addContentPass(${content.id})" style="padding:4px 8px;font-size:11px">+ å¯†ç </button>
                <input type="file" data-id="${content.id}" style="display:none" onchange="addContentFile(${content.id}, this)">
                <button onclick="document.querySelector('input[data-id=\"${content.id}\"]').click()" style="padding:4px 8px;font-size:11px">+ æ–‡ä»¶</button>
            </div>
            
            <div class="multi-content-locks">
                ${content.passwords.map(p => `<span class="lock-tag">ğŸ”‘ ${p}</span>`).join('')}
                ${content.files.map(f => `<span class="lock-tag">ğŸ“ ${f.name}</span>`).join('')}
            </div>
        </div>
    `).join('');
}

// æ·»åŠ å†…å®¹
function addContent() {
    const id = Date.now();
    multiContents.push({
        id: id,
        name: `å†…å®¹${multiContents.length + 1}`,
        html: '',
        passwords: [],
        files: []
    });
    renderMultiContents();
}

// æ›´æ–°å†…å®¹åç§°
function updateContentName(id, name) {
    const content = multiContents.find(c => c.id === id);
    if (content) content.name = name;
}

// æ›´æ–°å†…å®¹HTML
function updateContentHtml(id, html) {
    const content = multiContents.find(c => c.id === id);
    if (content) content.html = html;
}

// ç§»é™¤å†…å®¹
function removeContent(id) {
    if (multiContents.length > 1) {
        multiContents = multiContents.filter(c => c.id !== id);
        renderMultiContents();
    } else {
        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå†…å®¹');
    }
}

// ä¸ºå†…å®¹æ·»åŠ å¯†ç 
function addContentPass(id) {
    const input = document.querySelector(`input[data-id="${id}"]`);
    const pass = input.value.trim();
    if (!pass) return;
    
    const content = multiContents.find(c => c.id === id);
    if (content && !content.passwords.includes(pass)) {
        content.passwords.push(pass);
        renderMultiContents();
    }
    input.value = '';
}

// ä¸ºå†…å®¹æ·»åŠ æ–‡ä»¶é”
function addContentFile(id, fileInput) {
    const file = fileInput.files[0];
    if (!file) return;
    
    const content = multiContents.find(c => c.id === id);
    if (content && !content.files.some(f => f.name === file.name && f.size === file.size)) {
        content.files.push(file);
        renderMultiContents();
    }
    fileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
}

// æ–‡ä»¶é€‰æ‹©å’Œæ‹–æ”¾åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('srcHtmlContainer');
    const textarea = document.getElementById('srcHtml');
    const fileInput = document.getElementById('srcHtmlFile');
    
    // æ‹–æ”¾äº‹ä»¶
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        
        const file = e.dataTransfer.files[0];
        if (file && (file.name.endsWith('.html') || file.name.endsWith('.htm') || file.type === 'text/html')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                textarea.value = e.target.result;
                // å¦‚æœå¤šå†…å®¹åˆ—è¡¨ä¸ºç©ºï¼Œè‡ªåŠ¨æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªå†…å®¹
                if (multiContents.length === 0) {
                    initMultiContents();
                }
                if (multiContents.length > 0) {
                    multiContents[0].html = e.target.result;
                    renderMultiContents();
                }
            };
            reader.readAsText(file);
        } else {
            alert('è¯·é€‰æ‹© HTML æ–‡ä»¶');
        }
    });
    
    // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                textarea.value = e.target.result;
                // å¦‚æœå¤šå†…å®¹åˆ—è¡¨ä¸ºç©ºï¼Œè‡ªåŠ¨æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªå†…å®¹
                if (multiContents.length === 0) {
                    initMultiContents();
                }
                if (multiContents.length > 0) {
                    multiContents[0].html = e.target.result;
                    renderMultiContents();
                }
            };
            reader.readAsText(file);
        }
    });
    
    // åˆå§‹åŒ–å¤šå†…å®¹
    initMultiContents();
});

// è‡ªå®šä¹‰ä¸»å¯†é’¥åŠŸèƒ½
function setCustomKey() {
    const currentKey = document.getElementById('masterKey').value;
    const newKey = prompt('è¯·è¾“å…¥è‡ªå®šä¹‰ä¸»å¯†é’¥ï¼ˆ32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰ï¼š', currentKey || CryptoJS.lib.WordArray.random(32).toString());
    if (newKey && newKey.length === 64) {
        masterKey = newKey;
        document.getElementById('masterKey').value = masterKey;
        vault = [];
        renderVault();
        alert('ä¸»å¯†é’¥å·²è®¾ç½®æˆåŠŸï¼');
    } else if (newKey) {
        alert('å¯†é’¥å¿…é¡»æ˜¯64ä½åå…­è¿›åˆ¶å­—ç¬¦ï¼ˆ32å­—èŠ‚ï¼‰');
    }
}

// åˆå§‹åŒ–å¯†é’¥
function initKey() {
    masterKey = CryptoJS.lib.WordArray.random(32).toString();
    document.getElementById('masterKey').value = masterKey;
    vault = [];
    renderVault();
}

// åŸæœ‰çš„è§£é”ç­–ç•¥å‡½æ•°
function addPass(){
    const p=document.getElementById('txtPass').value; if(!p)return;
    vault.push({type:'PASS',desc:p,lock:CryptoJS.AES.encrypt("OK|"+masterKey,p).toString()});
    document.getElementById('txtPass').value=''; renderVault();
}
function addFile(){
    const f=document.getElementById('filePass').files[0]; if(!f)return;
    const r=new FileReader();
    r.onload=e=>{
        const h=CryptoJS.SHA256(CryptoJS.lib.WordArray.create(e.target.result)).toString();
        vault.push({type:'FILE',desc:f.name,lock:CryptoJS.AES.encrypt("OK|"+masterKey,h).toString()});
        renderVault();
    };
    r.readAsArrayBuffer(f);
}
function renderVault(){
    document.getElementById('vaultList').innerHTML=vault.map((v,i)=>`[${v.type}] ${v.desc} <a href="#" onclick="vault.splice(${i},1);renderVault()" style="color:red">x</a>`).join('; ');
}

// Monaco ç¼–è¾‘å™¨åˆå§‹åŒ–
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
require(['vs/editor/editor.main'], function() {
    editor = monaco.editor.create(document.getElementById('editor-container'), {
        value: defaultTemplate,
        language: 'html',
        theme: 'vs-dark',
        minimap: { enabled: false }
    });
    editor.onDidChangeModelContent(() => updatePreview());
    updatePreview();
});

// é»˜è®¤æ¨¡æ¿ä»£ç ï¼ˆä¿æŒä¸å˜ï¼‰
const defaultTemplate = `<!DOCTYPE html>
<html>
<head>
<style>
  body { background: #111; color: #fff; font-family: sans-serif; display: flex; height: 100vh; justify-content: center; align-items: center; margin: 0; }
  .box { background: #222; padding: 30px; border-radius: 10px; width: 300px; text-align: center; border: 1px solid #333; }
  input { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #444; color: #fff; box-sizing: border-box; border-radius: 4px; }
  button { width: 100%; padding: 10px; background: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
  button:hover { background: #1d4ed8; }
  .msg { color: #f87171; font-size: 12px; margin-top: 10px; min-height: 16px; }
  .hidden { display: none; }
  .tab { display: flex; margin-bottom: 15px; border-bottom: 1px solid #333; }
  .tab div { flex: 1; padding: 8px; cursor: pointer; opacity: 0.5; }
  .tab div.active { opacity: 1; border-bottom: 2px solid #2563eb; color: #2563eb; }
</style>
</head>
<body>
  <div class="box">
    <h2 style="margin-top:0">ğŸ”’ å·²åŠ å¯†å†…å®¹</h2>
    
    <div class="tab">
       <div id="tab-api" onclick="setMode('api')" class="active">API</div>
       <div id="tab-local" onclick="setMode('local')">æœ¬åœ°</div>
    </div>

    <!-- API è¾“å…¥ -->
    <div id="panel-api">
       <input type="text" id="token" placeholder="è¾“å…¥ Token..." onkeyup="if(event.key=='Enter') doApi()">
       <button onclick="doApi()" id="btn-api">éªŒè¯</button>
    </div>

    <!-- æœ¬åœ° è¾“å…¥ -->
    <div id="panel-local" class="hidden">
       <input type="password" id="pass" placeholder="å¯†ç ..." onkeyup="if(event.key=='Enter') doLocal()">
       <div style="margin:10px 0;font-size:12px;color:#666">- æˆ– -</div>
       <button onclick="document.getElementById('f').click()" style="background:#333">ğŸ“‚ é€‰æ‹©å¯†é’¥æ–‡ä»¶</button>
       <input type="file" id="f" style="display:none" onchange="window.LX.unlockWithFile(this.files[0])">
       <button onclick="doLocal()" style="margin-top:10px">è§£é”</button>
    </div>

    <div class="msg" id="msg-area"></div>
  </div>

<script>
  // 1. åˆå§‹åŒ–æ£€æŸ¥ï¼šå¦‚æœæ²¡å¯ç”¨ APIï¼Œè‡ªåŠ¨åˆ‡åˆ°æœ¬åœ°
  if(!window.LX.config.useApi) {
      document.getElementById('tab-api').style.display = 'none';
      setMode('local');
  }

  // 2. ç»‘å®šæ¶ˆæ¯å›è°ƒï¼Œæ¥æ”¶å†…æ ¸å‘æ¥çš„ä¿¡æ¯
  window.LX.onMessage = function(text, type) {
      const el = document.getElementById('msg-area');
      el.innerText = text;
      el.style.color = type === 'error' ? '#f87171' : '#4ade80';
      if(type === 'process') {
         document.getElementById('btn-api').innerText = 'éªŒè¯ä¸­...';
         document.getElementById('btn-api').disabled = true;
      } else {
         document.getElementById('btn-api').innerText = 'éªŒè¯';
         document.getElementById('btn-api').disabled = false;
      }
  };

  // 3. UI é€»è¾‘
  function setMode(m) {
      document.querySelectorAll('.tab div').forEach(d => d.classList.remove('active'));
      document.getElementById('tab-'+m).classList.add('active');
      document.getElementById('panel-api').classList.toggle('hidden', m!=='api');
      document.getElementById('panel-local').classList.toggle('hidden', m!=='local');
      document.getElementById('msg-area').innerText = '';
  }

  function doApi() {
      window.LX.unlockWithApi(document.getElementById('token').value);
  }

  function doLocal() {
      window.LX.unlock(document.getElementById('pass').value);
  }
<\/script>
</body>
</html>`;

function loadDefaultTemplate() { editor.setValue(defaultTemplate); }

function updatePreview() {
    const frame = document.getElementById('previewFrame');
    const html = editor.getValue();
    // æ³¨å…¥æ¨¡æ‹Ÿçš„ LX å¯¹è±¡ï¼Œé˜²æ­¢é¢„è§ˆæŠ¥é”™
    const mockScript = `<script>
        window.LX = {
            config: { useApi: true },
            contents: ['é»˜è®¤å†…å®¹', 'å†…å®¹2'],
            unlock: (p)=>alert('é¢„è§ˆæ¨¡å¼: å°è¯•ç”¨å¯†ç  '+p+' è§£é”'),
            unlockWithApi: (t)=>alert('é¢„è§ˆæ¨¡å¼: å°è¯•ç”¨API Token '+t+' è§£é”'),
            unlockWithFile: (f)=>alert('é¢„è§ˆæ¨¡å¼: æ–‡ä»¶å·²é€‰æ‹©'),
            unlockContent: (i,k)=>alert('é¢„è§ˆæ¨¡å¼: è§£é”å†…å®¹'+i),
            onMessage: (m)=>console.log(m)
        }
    <\/script>`;
    frame.srcdoc = html.replace('</body>', mockScript + '</body>');
}

// ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶ï¼ˆæ”¯æŒå¤šå†…å®¹å’ŒåŸæœ‰åŠŸèƒ½ï¼‰
function generate() {
    // è·å–åŸå§‹HTMLå†…å®¹ï¼ˆå…¼å®¹åŸæœ‰æ–¹å¼ï¼‰
    const srcHtml = document.getElementById('srcHtml').value;
    
    // å‡†å¤‡å†…å®¹é…ç½®
    let contentConfigs = [];
    
    // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨å¤šå†…å®¹é…ç½®
    const useMultiContent = multiContents.some(content => content.html.trim() !== '');
    
    if (useMultiContent) {
        // ä½¿ç”¨å¤šå†…å®¹é…ç½®
        for (const content of multiContents) {
            if (content.html.trim() === '') continue;
            
            // åŠ å¯†HTMLå†…å®¹
            const encryptedContent = CryptoJS.AES.encrypt(content.html, masterKey).toString();
            
            // å‡†å¤‡é”åˆ—è¡¨
            const locks = [];
            
            // æ·»åŠ å¯†ç é”
            content.passwords.forEach(pass => {
                locks.push(CryptoJS.AES.encrypt("OK|" + masterKey, pass).toString());
            });
            
            // æ·»åŠ æ–‡ä»¶é”
            content.files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const hash = CryptoJS.SHA256(CryptoJS.lib.WordArray.create(e.target.result)).toString();
                    locks.push(CryptoJS.AES.encrypt("OK|" + masterKey, hash).toString());
                };
                reader.readAsArrayBuffer(file);
            });
            
            contentConfigs.push({
                name: content.name,
                encryptedContent: encryptedContent,
                locks: locks
            });
        }
    } else if (srcHtml.trim() !== '') {
        // ä½¿ç”¨åŸæœ‰çš„å•ä¸ªå†…å®¹æ–¹å¼
        const encryptedContent = CryptoJS.AES.encrypt(srcHtml, masterKey).toString();
        
        // å‡†å¤‡é”åˆ—è¡¨ï¼ˆä½¿ç”¨å…¨å±€vaultï¼‰
        const locks = vault.map(v => v.lock);
        
        contentConfigs.push({
            name: 'åŠ å¯†å†…å®¹',
            encryptedContent: encryptedContent,
            locks: locks
        });
    } else {
        return alert('è¯·å¡«å…¥åŸå§‹å†…å®¹æˆ–é…ç½®å¤šå†…å®¹');
    }
    
    // å‡†å¤‡APIé…ç½®
    const apiConfig = {
        enabled: document.getElementById('useApi').checked,
        url: document.getElementById('apiUrl').value,
        type: document.getElementById('apiType').value,
        path: document.getElementById('apiPath').value
    };
    
    // æå–ç”¨æˆ·æ¨¡æ¿ (å¦‚æœä¸ºç©ºåˆ™ç”¨é»˜è®¤)
    let userHtml = editor.getValue() || defaultTemplate;
    
    // æ„å»ºå†…æ ¸è„šæœ¬ (Core Loader)
    // è¿™æ®µè„šæœ¬ä¼šæ³¨å…¥åˆ°ç”¨æˆ·æ¨¡æ¿çš„åº•éƒ¨
    const coreScript = `
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"><\/script>
<script>
(function(){
    const CONTENTS = ${JSON.stringify(contentConfigs.map(c => ({
        name: c.name,
        encryptedContent: c.encryptedContent,
        locks: c.locks
    })))};
    
    const API = ${JSON.stringify(apiConfig)};
    
    // å®šä¹‰æ¥å£
    window.LX = {
        config: { useApi: API.enabled },
        contents: CONTENTS.map(c => c.name),
        onMessage: function(msg, type){ console.log(type, msg); }, // ç”¨æˆ·å¯è¦†ç›–
        
        // å¯†ç è§£é”ï¼ˆå°è¯•æ‰€æœ‰å†…å®¹ï¼‰
        unlock: function(key) {
             if(!key) return this.onMessage('è¯·è¾“å…¥å¯†ç ', 'error');
             this._tryUnlockAll([key]);
        },
        
        // æ–‡ä»¶è§£é”ï¼ˆå°è¯•æ‰€æœ‰å†…å®¹ï¼‰
        unlockWithFile: function(file) {
            if(!file) return this.onMessage('è¯·é€‰æ‹©æ–‡ä»¶', 'error');
            const r = new FileReader();
            r.onload = e => {
                const hash = CryptoJS.SHA256(CryptoJS.lib.WordArray.create(e.target.result)).toString();
                this._tryUnlockAll([hash]);
            };
            r.readAsArrayBuffer(file);
        },
        
        // API è§£é”ï¼ˆè¿”å›ä¸»å¯†é’¥ï¼‰
        unlockWithApi: async function(token) {
            if(!API.enabled) return this.onMessage('API æœªå¯ç”¨', 'error');
            if(!token) return this.onMessage('è¯·è¾“å…¥ Token', 'error');
            
            this.onMessage('æ­£åœ¨è¿æ¥éªŒè¯...', 'process');
            try {
                const url = API.url.replace('{KEY}', encodeURIComponent(token));
                const res = await fetch(url);
                if(!res.ok) throw new Error('API çŠ¶æ€ç  ' + res.status);
                
                let mk = '';
                if(API.type === 'json') {
                    const json = await res.json();
                    mk = API.path.split('.').reduce((o,i)=>o?o[i]:null, json);
                } else {
                    mk = await res.text();
                }
                
                if(!mk) throw new Error('è¿”å›æ•°æ®æ— æ•ˆ');
                this._unlockWithMasterKey(mk.trim());
                
            } catch(e) {
                this.onMessage('éªŒè¯å¤±è´¥: ' + e.message, 'error');
            }
        },
        
        // ç›´æ¥è§£é”ç‰¹å®šå†…å®¹
        unlockContent: function(index, key) {
            if(index < 0 || index >= CONTENTS.length) {
                return this.onMessage('å†…å®¹ä¸å­˜åœ¨', 'error');
            }
            this._unlockContent(index, key);
        },
        
        // å†…éƒ¨ï¼šå°è¯•ç”¨ Key åˆ—è¡¨è§£å¼€æ‰€æœ‰å†…å®¹
        _tryUnlockAll: function(keys) {
            for(let i = 0; i < CONTENTS.length; i++) {
                const content = CONTENTS[i];
                for(let key of keys) {
                    for(let lock of content.locks) {
                        try {
                            const bytes = CryptoJS.AES.decrypt(lock, key);
                            const str = bytes.toString(CryptoJS.enc.Utf8);
                            if(str.startsWith("OK|")) {
                                this._unlockContent(i, str.split('|')[1]);
                                return;
                            }
                        } catch(e) {}
                    }
                }
            }
            window.LX.onMessage('å¯†ç é”™è¯¯æˆ–æ–‡ä»¶ä¸åŒ¹é…', 'error');
        },
        
        // å†…éƒ¨ï¼šä½¿ç”¨ä¸»å¯†é’¥è§£é”ï¼ˆè§£é”ç¬¬ä¸€ä¸ªå†…å®¹ï¼‰
        _unlockWithMasterKey: function(masterKey) {
            if(CONTENTS.length > 0) {
                this._unlockContent(0, masterKey);
            }
        },
        
        // å†…éƒ¨ï¼šæœ€ç»ˆè§£å¯†ä¸æ›¿æ¢
        _unlockContent: function(index, mk) {
            try {
                const content = CONTENTS[index];
                const bytes = CryptoJS.AES.decrypt(content.encryptedContent, mk);
                const html = bytes.toString(CryptoJS.enc.Utf8);
                if(!html || !html.includes('<')) throw new Error();
                
                this.onMessage('è§£é”æˆåŠŸ: ' + content.name, 'success');
                setTimeout(() => {
                    document.open();
                    document.write(html);
                    document.close();
                }, 500);
            } catch(e) {
                window.LX.onMessage('æ•°æ®è§£å¯†å¤±è´¥', 'error');
            }
        }
    };
})();
<\/script>`;

    // 5. ç»„åˆæœ€ç»ˆæ–‡ä»¶
    // å°† Core Script æ’å…¥åˆ°ç”¨æˆ· HTML çš„ </body> ä¹‹å‰ï¼Œæˆ–è€…æœ€å
    let finalHtml = "";
    if(userHtml.includes('</body>')) {
        finalHtml = userHtml.replace('</body>', coreScript + '</body>');
    } else {
        finalHtml = userHtml + coreScript;
    }

    // 6. å¯¼å‡º
    const blob = new Blob([finalHtml], {type: "text/html"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "index.html";
    a.click();
}

// åˆå§‹åŒ–
initKey();
</script>
</body>
</html>