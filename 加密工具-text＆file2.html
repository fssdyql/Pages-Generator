<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ç¦»çº¿ç½‘é¡µå‘å¸ƒä¸“ç”¨åŠ å¯†å™¨</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
    body{font-family:"Segoe UI",Roboto,sans-serif;background:#f1f5f9;color:#334155;max-width:900px;margin:20px auto;padding:20px}
    .card{background:#fff;border-radius:12px;padding:24px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);margin-bottom:20px}
    h2{margin-top:0;font-size:18px;border-bottom:1px solid #e2e8f0;padding-bottom:12px;color:#0f172a}
    textarea{width:100%;height:150px;font-family:monospace;padding:12px;border:1px solid #cbd5e1;border-radius:8px;resize:vertical;font-size:13px;display:block;box-sizing:border-box}
    .row{display:flex;gap:10px;margin-bottom:10px}
    input[type="text"]{flex:1;padding:10px;border:1px solid #cbd5e1;border-radius:6px}
    button{padding:10px 20px;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:0.2s}
    button:hover{filter:brightness(0.95)}
    button.red{background:#ef4444}
    button.green{background:#10b981}
    .key-list{margin-top:15px;background:#f8fafc;padding:10px;border-radius:8px;border:1px dashed #cbd5e1}
    .key-item{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:8px 12px;margin-bottom:6px;border-radius:6px;border:1px solid #e2e8f0;font-size:14px}
    .badge{font-size:12px;padding:2px 6px;border-radius:4px;background:#e0f2fe;color:#0369a1;margin-right:8px}
    .badge.file{background:#fce7f3;color:#be185d}
</style>
</head>
<body>

<!-- ç¬¬ä¸€æ­¥ï¼šç²˜è´´æºç  -->
<div class="card">
    <h2>1. ç²˜è´´åŸæœ¬çš„ç¦»çº¿ç½‘é¡µä»£ç </h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:10px">è¯·å°†ä½ æœ€å¼€å§‹å‘ç»™æˆ‘çš„é‚£ä¸ªåŒ…å« `DB`ã€`é‡è‰.js`ã€`download` åŠŸèƒ½çš„å®Œæ•´ HTML ç²˜è´´åœ¨ä¸‹é¢ï¼š</p>
    <textarea id="srcHtml" placeholder="<!DOCTYPE html>..."></textarea>
</div>

<!-- ç¬¬äºŒæ­¥ï¼šé…ç½®é’¥åŒ™ -->
<div class="card">
    <h2>2. é…ç½®è§£é”æ–¹å¼ (Key Vault)</h2>
    
    <!-- æ–‡æœ¬å¯†ç  -->
    <div class="row">
        <input type="text" id="txtPass" placeholder="è¾“å…¥å¯†ç  (å¦‚: 123456)">
        <button onclick="addKey('PASS')">â• æ·»åŠ å¯†ç </button>
    </div>

    <!-- æ–‡ä»¶å¯†ç  -->
    <div class="row" style="border-top:1px dashed #e2e8f0;padding-top:15px;margin-top:15px">
        <input type="file" id="filePass">
        <button class="green" onclick="addFileKey()">â• æ·»åŠ æ–‡ä»¶é” (ä¸Šä¼ æ–‡ä»¶)</button>
    </div>
    <div style="font-size:12px;color:#64748b">æ–‡ä»¶é”åŸç†ï¼šç”¨æˆ·å¿…é¡»ä¸Šä¼ <b>å®Œå…¨ç›¸åŒ</b>çš„æ–‡ä»¶ï¼ˆæ£€æŸ¥å“ˆå¸Œå€¼ï¼‰æ‰èƒ½è§£é”ã€‚</div>

    <!-- é’¥åŒ™åˆ—è¡¨ -->
    <div class="key-list" id="keyList">
        <div style="text-align:center;color:#94a3b8;font-size:12px">æš‚æ— é’¥åŒ™ï¼Œè¯·æ·»åŠ ...</div>
    </div>
</div>

<!-- ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆ -->
<div class="card">
    <h2>3. ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶</h2>
    <button onclick="generate()" style="width:100%;height:50px;font-size:16px">ğŸ”’ ç”ŸæˆåŠ å¯†ç½‘é¡µ (index.html)</button>
    <textarea id="resHtml" readonly placeholder="ç”Ÿæˆç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." style="margin-top:15px;height:200px;background:#f8fafc"></textarea>
</div>

<script>
    let vaultKeys = []; // å­˜å‚¨æ‰€æœ‰çš„é’¥åŒ™

    // æ¸²æŸ“é’¥åŒ™åˆ—è¡¨
    function render() {
        const el = document.getElementById('keyList');
        if(vaultKeys.length===0) {
            el.innerHTML = '<div style="text-align:center;color:#94a3b8;font-size:12px">æš‚æ— é’¥åŒ™ï¼Œè¯·æ·»åŠ ...</div>';
            return;
        }
        el.innerHTML = vaultKeys.map((k,i)=>`
            <div class="key-item">
                <span><span class="badge ${k.type==='FILE'?'file':''}">${k.type}</span> ${k.desc}</span>
                <button class="red" style="padding:4px 10px;font-size:12px" onclick="delKey(${i})">åˆ é™¤</button>
            </div>
        `).join('');
    }

    function addKey(type) {
        const val = document.getElementById('txtPass').value.trim();
        if(!val) return;
        vaultKeys.push({type: 'PASS', val: val, desc: val});
        document.getElementById('txtPass').value = '';
        render();
    }

    function addFileKey() {
        const f = document.getElementById('filePass').files[0];
        if(!f) return alert('è¯·é€‰æ‹©æ–‡ä»¶');
        const reader = new FileReader();
        reader.onload = e => {
            const hash = CryptoJS.SHA256(CryptoJS.lib.WordArray.create(e.target.result)).toString();
            vaultKeys.push({type: 'FILE', val: hash, desc: 'æ–‡ä»¶: '+f.name});
            render();
        };
        reader.readAsArrayBuffer(f);
    }

    function delKey(i){ vaultKeys.splice(i,1); render(); }

    function generate() {
        const source = document.getElementById('srcHtml').value;
        if(!source || vaultKeys.length === 0) return alert("è¯·ç²˜è´´æºç å¹¶è‡³å°‘æ·»åŠ ä¸€æŠŠé’¥åŒ™ï¼");

        // 1. ç”Ÿæˆéšæœºä¸»å¯†é’¥ (Master Key)
        const masterKey = CryptoJS.lib.WordArray.random(32).toString();

        // 2. ç”¨ä¸»å¯†é’¥åŠ å¯†åŸæœ¬çš„ HTML
        const encryptedSource = CryptoJS.AES.encrypt(source, masterKey).toString();

        // 3. æ„å»ºé’¥åŒ™åŒ… (Vault)
        // æ¯ä¸€ä¸ª Vault Item éƒ½æ˜¯ï¼šç”¨ç”¨æˆ·çš„å¯†ç åŠ å¯†åçš„ (MasterKey + æ ¡éªŒç )
        const checkToken = "OK_LX_UNLOCK|";
        const vaultData = vaultKeys.map(k => {
            return CryptoJS.AES.encrypt(checkToken + masterKey, k.val).toString();
        });

        // 4. ç”Ÿæˆæœ€ç»ˆ HTML æ¨¡æ¿
        const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restricted Access</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"><\/script>
<style>
body{background:#111827;display:flex;height:100vh;justify-content:center;align-items:center;margin:0;font-family:monospace;color:#e2e8f0}
.box{width:90%;max-width:380px;background:#1e293b;padding:30px;border-radius:16px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.5);border:1px solid #334155}
h3{text-align:center;margin-top:0;color:#38bdf8;letter-spacing:1px}
.tab{display:flex;margin-bottom:20px;border-bottom:1px solid #334155}
.tab span{flex:1;text-align:center;padding:10px;cursor:pointer;transition:0.3s;color:#64748b}
.tab span.active{color:#38bdf8;border-bottom:2px solid #38bdf8}
.p{display:none}
.p.active{display:block}
input{width:100%;padding:12px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#fff;outline:none;box-sizing:border-box;margin-bottom:15px;text-align:center}
input:focus{border-color:#38bdf8}
button{width:100%;padding:12px;background:#38bdf8;color:#0f172a;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
button:hover{filter:brightness(1.1)}
.file-box{border:2px dashed #334155;padding:20px;text-align:center;border-radius:8px;margin-bottom:15px;cursor:pointer}
.file-box:hover{border-color:#38bdf8;background:#0f172a}
#msg{text-align:center;margin-top:15px;color:#f43f5e;font-size:12px;min-height:18px}
</style>
</head>
<body>
<div class="box" id="ui">
    <h3>ğŸ”’ LX Source Protect</h3>
    <div class="tab">
        <span class="active" onclick="s(0)">å¯†ç è§£é”</span>
        <span onclick="s(1)">æ–‡ä»¶è§£é”</span>
    </div>
    
    <!-- å¯†ç é¢æ¿ -->
    <div class="p active">
        <input type="password" id="kp" placeholder="è¯·è¾“å…¥è®¿é—®å¯†é’¥..." onkeyup="if(event.key==='Enter')dec(this.value)">
        <button onclick="dec(document.getElementById('kp').value)">è§£é”å†…å®¹</button>
    </div>

    <!-- æ–‡ä»¶é¢æ¿ -->
    <div class="p">
        <div class="file-box" onclick="document.getElementById('kf').click()">
            <div id="fn">ğŸ“ ç‚¹å‡»é€‰æ‹©å¯†é’¥æ–‡ä»¶</div>
        </div>
        <input type="file" id="kf" style="display:none" onchange="readF(this)">
        <button onclick="decFile()">è§£é”å†…å®¹</button>
    </div>
    
    <div id="msg"></div>
</div>

<script>
// è¿™é‡Œå­˜å‚¨äº†åŠ å¯†åçš„ä¸»å¯†é’¥åˆ—è¡¨å’Œç½‘é¡µå†…å®¹
const V = ${JSON.stringify(vaultData)};
const C = "${encryptedSource}";
let fk = null;

function s(i){
    document.querySelectorAll('.tab span').forEach((e,n)=>e.classList.toggle('active',i===n));
    document.querySelectorAll('.p').forEach((e,n)=>e.classList.toggle('active',i===n));
    msg('');
}

function readF(el){
    if(!el.files[0]) return;
    document.getElementById('fn').innerText = "ğŸ“„ " + el.files[0].name;
    const r = new FileReader();
    r.onload = e => {
        // è®¡ç®—æ–‡ä»¶å“ˆå¸Œä½œä¸ºå¯†é’¥
        fk = CryptoJS.SHA256(CryptoJS.lib.WordArray.create(e.target.result)).toString();
    };
    r.readAsArrayBuffer(el.files[0]);
}

function decFile(){ if(fk) dec(fk); else msg('è¯·å…ˆé€‰æ‹©æ–‡ä»¶'); }

function msg(t){ 
    const m = document.getElementById('msg');
    m.innerText=t; 
    if(t) {
        const b=document.getElementById('ui');
        b.style.transform='translateX(5px)';
        setTimeout(()=>b.style.transform='translateX(0)',100);
        setTimeout(()=>b.style.transform='translateX(-5px)',200);
        setTimeout(()=>b.style.transform='translateX(0)',300);
    }
}

function dec(key){
    if(!key) return msg('è¯·è¾“å…¥å¯†é’¥');
    
    let mk = null;
    // å°è¯•éå†æ‰€æœ‰çš„é”ï¼Œçœ‹çœ‹è¿™æŠŠé’¥åŒ™èƒ½å¼€å“ªä¸€ä¸ª
    for(let i=0; i<V.length; i++){
        try{
            const bytes = CryptoJS.AES.decrypt(V[i], key);
            const str = bytes.toString(CryptoJS.enc.Utf8);
            if(str.startsWith("OK_LX_UNLOCK|")){
                mk = str.split('|')[1];
                break;
            }
        }catch(e){}
    }

    if(mk){
        try{
            // ç”¨æå–å‡ºçš„ä¸»å¯†é’¥è§£å¯†çœŸæ­£çš„ç½‘é¡µ
            const bytes = CryptoJS.AES.decrypt(C, mk);
            const originalHtml = bytes.toString(CryptoJS.enc.Utf8);
            if(!originalHtml) throw new Error();
            
            // æ ¸å¿ƒæ­¥éª¤ï¼šé‡å†™æ•´ä¸ªæ–‡æ¡£ï¼Œæ¢å¤åŸæœ¬çš„åŠŸèƒ½
            document.open();
            document.write(originalHtml);
            document.close();
        }catch(e){
            msg('æ•°æ®æŸåï¼Œæ— æ³•è¿˜åŸ');
        }
    }else{
        msg('å¯†é’¥é”™è¯¯ / æ–‡ä»¶ä¸åŒ¹é…');
    }
}
<\/script>
</body>
</html>`;

        document.getElementById('resHtml').value = html;
    }
</script>
</body>
</html>