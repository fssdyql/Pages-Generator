<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ç½‘é¡µåŠ å¯†ç”Ÿæˆå™¨ v6.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
<style>
    :root { --p: #2563eb; --bg: #f8fafc; }
    body{font-family:"Segoe UI",sans-serif;background:var(--bg);color:#334155;margin:0;padding:20px;max-width:1200px;margin:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid #e2e8f0;margin-bottom:20px}
    h2{margin-top:0;font-size:16px;border-bottom:1px solid #f1f5f9;padding-bottom:10px;color:#0f172a;display:flex;justify-content:space-between;align-items:center}
    
    label{font-size:12px;font-weight:600;color:#64748b;display:block;margin-bottom:5px}
    input[type=text],input[type=password],select{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;margin-bottom:10px;box-sizing:border-box}
    button{padding:8px 16px;background:var(--p);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600}
    button:hover{filter:brightness(0.9)}
    button.gray{background:#64748b}
    button.green{background:#10b981}
    button.red{background:#ef4444}
    
    .guide-box{background:#1e293b;color:#e2e8f0;padding:15px;border-radius:8px;font-family:monospace;font-size:12px;overflow-x:auto;line-height:1.5}
    .guide-tag{color:#38bdf8;font-weight:bold}
    .guide-com{color:#94a3b8;font-style:italic}
    
    #editor-container{height:400px;border:1px solid #cbd5e1;border-radius:6px;overflow:hidden}
    .preview-iframe{width:100%;height:300px;border:none;border-radius:6px;background:#fff;border:1px solid #cbd5e1}

    /* æ–°å¢æ ·å¼ */
    .drop-zone { border: 2px dashed #cbd5e1; transition: background 0.2s; }
    .drop-zone.dragover { background: #e0f2fe; border-color: var(--p); }
    .sub-page-item { background: #f1f5f9; padding: 10px; border-radius: 6px; margin-bottom: 5px; font-size: 13px; border: 1px solid #e2e8f0; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 5px; }
    .badge-main { background: #dbeafe; color: #1e40af; }
    .badge-sub { background: #dcfce7; color: #166534; }
</style>
</head>
<body>

<div style="margin-bottom:20px;display:flex;justify-content:space-between;align-items:center">
    <h1 style="margin:0;font-size:20px">ğŸ“¦ ç¦»çº¿ç½‘é¡µåŠ å¯†ç”Ÿæˆå™¨ <span style="font-size:12px;font-weight:normal;color:#64748b">v6.0
</span></h1>
    <div>
        <button class="gray" onclick="loadDefaultTemplate()">ğŸ”„ åŠ è½½é»˜è®¤æ¨¡æ¿</button>
        <button onclick="generate()">ğŸš€ ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶</button>
    </div>
</div>

<div class="grid">
    <!-- å·¦ä¾§ï¼šé…ç½®åŒº -->
    <div>
        <!-- 1. æ ¸å¿ƒæ•°æ® -->
        <div class="card">
            <h2>1. æ•°æ®æºä¸å¯†é’¥</h2>
            <label>ä¸»å¯†é’¥ (Main Key)</label>
            <div style="display:flex;gap:10px;margin-bottom:10px">
                <input type="text" id="masterKey" readonly style="background:#f1f5f9;color:#059669;font-weight:bold">
                <button class="gray" onclick="initKey()">ğŸ”„ åˆ·æ–°</button>
                <button class="gray" onclick="customKey()">âœï¸ è‡ªå®šä¹‰</button>
            </div>
            
            <label>ä¸»é¡µé¢å†…å®¹ (é»˜è®¤è§£é”åæ˜¾ç¤ºçš„å†…å®¹)</label>
            <div style="position:relative">
                <textarea id="srcHtml" class="drop-zone" style="width:100%;height:80px;border:1px solid #cbd5e1;border-radius:6px" placeholder="åœ¨æ­¤ç²˜è´´ HTMLï¼Œæˆ–æ‹–å…¥æ–‡ä»¶..."></textarea>
                <div style="text-align:right; margin-top:5px;">
                     <input type="file" id="mainFileSelect" style="display:none" onchange="readFileToArea(this, 'srcHtml')">
                     <button class="gray" style="padding:4px 10px; font-size:12px" onclick="document.getElementById('mainFileSelect').click()">ğŸ“‚ å¯¼å…¥æ–‡ä»¶</button>
                </div>
            </div>

            <!-- å¤šé¡µé¢é…ç½® -->
            <div style="margin-top:15px; border-top:1px dashed #cbd5e1; padding-top:15px;">
                <label style="color:#2563eb">ğŸ“‘ å¤šé¡µé¢é…ç½® (è¾“å…¥ä¸åŒå¯†ç æ‰“å¼€ä¸åŒå†…å®¹)</label>
                <div id="subPageList" style="margin-bottom:10px;"></div>
                
                <div style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0">
                    <input type="text" id="subPass" placeholder="è®¾ç½®è¯¥é¡µé¢çš„ç‹¬ç«‹å¯†ç " style="margin-bottom:5px">
                    <textarea id="subHtml" class="drop-zone" style="width:100%;height:60px;border:1px solid #cbd5e1;border-radius:6px;margin-bottom:5px" placeholder="è¯¥é¡µé¢çš„ HTML å†…å®¹ (æ”¯æŒæ‹–å…¥æ–‡ä»¶)"></textarea>
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <input type="file" id="subFileSelect" style="display:none" onchange="readFileToArea(this, 'subHtml')">
                            <button class="gray" style="padding:4px 10px; font-size:12px" onclick="document.getElementById('subFileSelect').click()">ğŸ“‚ é€‰æ–‡ä»¶</button>
                        </div>
                        <button class="green" onclick="addSubPage()">â• æ·»åŠ é¡µé¢</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. è§£é”ç­–ç•¥ -->
        <div class="card">
            <h2>2. ä¸»é¡µé¢è§£é”ç­–ç•¥</h2>
            <p style="font-size:12px;color:#64748b;margin:0 0 10px 0">æ³¨æ„ï¼šä»¥ä¸‹ç­–ç•¥ä»…ç”¨äºè§£é”â€œä¸»é¡µé¢â€ã€‚å¤šé¡µé¢å†…å®¹ç”±å…¶ç‹¬ç«‹å¯†ç ç›´æ¥è§£é”ï¼Œä¸ç»è¿‡APIæˆ–å¯†é’¥æ–‡ä»¶ã€‚</p>
            
            <div style="background:#f8fafc;padding:10px;border-radius:6px;margin-bottom:10px">
                <label>
                    <input type="checkbox" id="useApi" onchange="document.getElementById('apiSet').style.display=this.checked?'block':'none'"> 
                    å¯ç”¨è¿œç¨‹ API éªŒè¯
                </label>
                <div id="apiSet" style="display:none;margin-top:10px;border-top:1px dashed #cbd5e1;padding-top:10px">
                    <input type="text" id="apiUrl" placeholder="URL: https://api.com/auth?k={KEY}">
                    <div style="display:flex;gap:5px">
                        <select id="apiType"><option value="text">çº¯æ–‡æœ¬</option><option value="json">JSON</option></select>
                        <input type="text" id="apiPath" placeholder="JSONè·¯å¾„ (å¦‚ data.key)">
                    </div>
                </div>
            </div>

            <div style="background:#f8fafc;padding:10px;border-radius:6px">
                <label>æœ¬åœ°å¤‡ç”¨å¯†é’¥ (è§£é”ä¸»é¡µé¢)</label>
                <div style="display:flex;gap:5px;margin-bottom:5px">
                    <input type="text" id="txtPass" placeholder="æ·»åŠ å¯†ç ...">
                    <button onclick="addPass()">â•</button>
                </div>
                <div style="display:flex;gap:5px">
                    <input type="file" id="filePass">
                    <button class="gray" onclick="addFile()">ğŸ“‚ åŠ æ–‡ä»¶é”</button>
                </div>
                <div id="vaultList" style="margin-top:5px;font-size:12px;color:#64748b"></div>
            </div>
        </div>

        <!-- 3. å¼€å‘æŒ‡å— -->
        <div class="card">
            <h2>ğŸ“– æ¨¡æ¿ç¼–å†™æŒ‡å—</h2>
            <div class="guide-box">
<span class="guide-com">// å†…æ ¸ä¼šè‡ªåŠ¨æ ¹æ®è¾“å…¥åˆ¤æ–­æ˜¯è§£é”ä¸»é¡µè¿˜æ˜¯åˆ†é¡µé¢</span>
<span class="guide-tag">window.LX.unlock(password)</span>
<span class="guide-com">-> å°è¯•è§£é”ä¸»é¡µæˆ–åˆ†é¡µé¢</span>

<span class="guide-tag">window.LX.unlockWithApi(token)</span>
<span class="guide-com">-> ä»…ç”¨äºè·å–ä¸»é¡µé¢çš„ MasterKey</span>

<span class="guide-tag">window.LX.onMessage = function(msg, type){}</span>
<span class="guide-com">-> æ¥æ”¶é”™è¯¯/çŠ¶æ€æ¶ˆæ¯</span>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šæ¨¡æ¿ç¼–è¾‘ -->
    <div>
        <div class="card" style="height:100%;display:flex;flex-direction:column;box-sizing:border-box">
            <h2>
                <span>3. è‡ªå®šä¹‰æ¨¡æ¿ (HTML)</span>
                <span style="font-size:12px;font-weight:normal;color:#64748b">å¦‚æœä¸å¡«ï¼Œåˆ™ä½¿ç”¨é»˜è®¤æš—é»‘ä¸»é¢˜</span>
            </h2>
            <div id="editor-container"></div>
            <textarea id="tplInput" style="display:none"></textarea>
            
            <h2 style="margin-top:20px">é¢„è§ˆ (ä»…ä¾› UI å‚è€ƒ)</h2>
            <iframe id="previewFrame" class="preview-iframe"></iframe>
        </div>
    </div>
</div>

<script>
// --- é€»è¾‘å¤„ç†éƒ¨åˆ† ---
let masterKey = '';
let vault = []; // ä¸»é¡µé¢çš„é”
let subPages = []; // é¢å¤–çš„é¡µé¢ {pass, html}
let editor;

require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
require(['vs/editor/editor.main'], function() {
    editor = monaco.editor.create(document.getElementById('editor-container'), {
        value: defaultTemplate,
        language: 'html',
        theme: 'vs-dark',
        minimap: { enabled: false }
    });
    editor.onDidChangeModelContent(() => updatePreview());
    updatePreview();
});

// åˆå§‹åŒ–ä¸ Key ç›¸å…³
function initKey(){ 
    masterKey=CryptoJS.lib.WordArray.random(32).toString(); 
    document.getElementById('masterKey').value=masterKey; 
    vault=[]; renderVault(); 
}

function customKey() {
    let k = prompt("è¯·è¾“å…¥è‡ªå®šä¹‰ä¸»å¯†é’¥ (å»ºè®®32ä½éšæœºå­—ç¬¦):", masterKey);
    if(k && k.trim() !== "") {
        masterKey = k.trim();
        document.getElementById('masterKey').value = masterKey;
        vault = []; // Keyå˜äº†ï¼Œæ—§é”å¤±æ•ˆï¼Œæ¸…ç©º
        renderVault();
        alert("ä¸»å¯†é’¥å·²æ›´æ–°ï¼Œè¯·é‡æ–°æ·»åŠ æœ¬åœ°å¤‡ç”¨å¯†ç ï¼ˆå› ä¸ºå®ƒä»¬æ˜¯åŸºäºä¸»å¯†é’¥åŠ å¯†çš„ï¼‰ã€‚");
    }
}

// ä¸»é¡µé¢é”é€»è¾‘
function addPass(){
    const p=document.getElementById('txtPass').value; if(!p)return;
    vault.push({type:'PASS',desc:p,lock:CryptoJS.AES.encrypt("OK|"+masterKey,p).toString()});
    document.getElementById('txtPass').value=''; renderVault();
}
function addFile(){
    const f=document.getElementById('filePass').files[0]; if(!f)return;
    const r=new FileReader();
    r.onload=e=>{
        const h=CryptoJS.SHA256(CryptoJS.lib.WordArray.create(e.target.result)).toString();
        vault.push({type:'FILE',desc:f.name,lock:CryptoJS.AES.encrypt("OK|"+masterKey,h).toString()});
        renderVault();
    };
    r.readAsArrayBuffer(f);
}
function renderVault(){
    document.getElementById('vaultList').innerHTML=vault.map((v,i)=>`[${v.type}] ${v.desc} <a href="#" onclick="vault.splice(${i},1);renderVault()" style="color:red">x</a>`).join('; ');
}

// å¤šé¡µé¢é€»è¾‘
function addSubPage() {
    const p = document.getElementById('subPass').value;
    const h = document.getElementById('subHtml').value;
    if(!p || !h) return alert("è¯·å¡«å†™å¯†ç å’ŒHTMLå†…å®¹");
    
    // ç®€å•çš„æŸ¥é‡
    if(subPages.some(x => x.pass === p)) return alert("è¯¥å¯†ç å·²å­˜åœ¨äºåˆ—è¡¨ä¸­");

    subPages.push({ pass: p, html: h });
    document.getElementById('subPass').value = '';
    document.getElementById('subHtml').value = '';
    renderSubPages();
}

function renderSubPages() {
    const el = document.getElementById('subPageList');
    if(subPages.length === 0) {
        el.innerHTML = '<div style="font-size:12px;color:#94a3b8;font-style:italic">æš‚æ— é¢å¤–é¡µé¢</div>';
        return;
    }
    el.innerHTML = subPages.map((page, i) => `
        <div class="sub-page-item" style="display:flex;justify-content:space-between;align-items:center">
            <div>
                <span class="badge badge-sub">é¡µé¢ ${i+1}</span>
                <span style="font-family:monospace">å¯†ç : ${page.pass}</span>
                <span style="color:#64748b;font-size:12px">(${page.html.length} chars)</span>
            </div>
            <button class="red" style="padding:4px 8px;font-size:12px" onclick="subPages.splice(${i},1);renderSubPages()">åˆ é™¤</button>
        </div>
    `).join('');
}

// æ–‡ä»¶è¯»å–ä¸æ‹–æ‹½
function readFileToArea(input, areaId) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = (e) => document.getElementById(areaId).value = e.target.result;
    r.readAsText(file);
    // é‡ç½®inputï¼Œå…è®¸é‡å¤é€‰åŒä¸€ä¸ªæ–‡ä»¶
    input.value = '';
}

function setupDragDrop(areaId) {
    const area = document.getElementById(areaId);
    area.addEventListener('dragover', (e) => { e.preventDefault(); area.classList.add('dragover'); });
    area.addEventListener('dragleave', (e) => { e.preventDefault(); area.classList.remove('dragover'); });
    area.addEventListener('drop', (e) => {
        e.preventDefault();
        area.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if(file) {
            const r = new FileReader();
            r.onload = (ev) => area.value = ev.target.result;
            r.readAsText(file);
        }
    });
}
setupDragDrop('srcHtml');
setupDragDrop('subHtml');


// é»˜è®¤æ¨¡æ¿ä»£ç 
const defaultTemplate = `<!DOCTYPE html>
<html>
<head>
<style>
  body { background: #111; color: #fff; font-family: sans-serif; display: flex; height: 100vh; justify-content: center; align-items: center; margin: 0; }
  .box { background: #222; padding: 30px; border-radius: 10px; width: 300px; text-align: center; border: 1px solid #333; }
  input { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #444; color: #fff; box-sizing: border-box; border-radius: 4px; }
  button { width: 100%; padding: 10px; background: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
  button:hover { background: #1d4ed8; }
  .msg { color: #f87171; font-size: 12px; margin-top: 10px; min-height: 16px; }
  .hidden { display: none; }
  .tab { display: flex; margin-bottom: 15px; border-bottom: 1px solid #333; }
  .tab div { flex: 1; padding: 8px; cursor: pointer; opacity: 0.5; }
  .tab div.active { opacity: 1; border-bottom: 2px solid #2563eb; color: #2563eb; }
</style>
</head>
<body>
  <div class="box">
    <h2 style="margin-top:0">ğŸ”’ å·²åŠ å¯†å†…å®¹</h2>
    
    <div class="tab">
       <div id="tab-api" onclick="setMode('api')" class="active">API</div>
       <div id="tab-local" onclick="setMode('local')">æœ¬åœ°</div>
    </div>

    <!-- API è¾“å…¥ -->
    <div id="panel-api">
       <input type="text" id="token" placeholder="è¾“å…¥ Token..." onkeyup="if(event.key=='Enter') doApi()">
       <button onclick="doApi()" id="btn-api">éªŒè¯</button>
    </div>

    <!-- æœ¬åœ° è¾“å…¥ -->
    <div id="panel-local" class="hidden">
       <input type="password" id="pass" placeholder="å¯†ç ..." onkeyup="if(event.key=='Enter') doLocal()">
       <div style="margin:10px 0;font-size:12px;color:#666">- æˆ– -</div>
       <button onclick="document.getElementById('f').click()" style="background:#333">ğŸ“‚ é€‰æ‹©å¯†é’¥æ–‡ä»¶</button>
       <input type="file" id="f" style="display:none" onchange="window.LX.unlockWithFile(this.files[0])">
       <button onclick="doLocal()" style="margin-top:10px">è§£é”</button>
    </div>

    <div class="msg" id="msg-area"></div>
  </div>

<script>
  // 1. åˆå§‹åŒ–æ£€æŸ¥ï¼šå¦‚æœæ²¡å¯ç”¨ APIï¼Œè‡ªåŠ¨åˆ‡åˆ°æœ¬åœ°
  if(!window.LX.config.useApi) {
      document.getElementById('tab-api').style.display = 'none';
      setMode('local');
  }

  // 2. ç»‘å®šæ¶ˆæ¯å›è°ƒï¼Œæ¥æ”¶å†…æ ¸å‘æ¥çš„ä¿¡æ¯
  window.LX.onMessage = function(text, type) {
      const el = document.getElementById('msg-area');
      el.innerText = text;
      el.style.color = type === 'error' ? '#f87171' : '#4ade80';
      if(type === 'process') {
         document.getElementById('btn-api').innerText = 'éªŒè¯ä¸­...';
         document.getElementById('btn-api').disabled = true;
      } else {
         document.getElementById('btn-api').innerText = 'éªŒè¯';
         document.getElementById('btn-api').disabled = false;
      }
  };

  // 3. UI é€»è¾‘
  function setMode(m) {
      document.querySelectorAll('.tab div').forEach(d => d.classList.remove('active'));
      document.getElementById('tab-'+m).classList.add('active');
      document.getElementById('panel-api').classList.toggle('hidden', m!=='api');
      document.getElementById('panel-local').classList.toggle('hidden', m!=='local');
      document.getElementById('msg-area').innerText = '';
  }

  function doApi() {
      window.LX.unlockWithApi(document.getElementById('token').value);
  }

  function doLocal() {
      window.LX.unlock(document.getElementById('pass').value);
  }
<\/script>
</body>
</html>`;

function loadDefaultTemplate() { editor.setValue(defaultTemplate); }

function updatePreview() {
    const frame = document.getElementById('previewFrame');
    const html = editor.getValue();
    const mockScript = `<script>
        window.LX = {
            config: { useApi: true },
            unlock: (p)=>alert('é¢„è§ˆæ¨¡å¼: å°è¯•ç”¨å¯†ç  '+p+' è§£é”'),
            unlockWithApi: (t)=>alert('é¢„è§ˆæ¨¡å¼: å°è¯•ç”¨API Token '+t+' è§£é”'),
            unlockWithFile: (f)=>alert('é¢„è§ˆæ¨¡å¼: æ–‡ä»¶å·²é€‰æ‹©'),
            onMessage: (m)=>console.log(m)
        }
    <\/script>`;
    frame.srcdoc = html.replace('</body>', mockScript + '</body>');
}

function generate() {
    const srcMain = document.getElementById('srcHtml').value;
    // å…è®¸ä¸»å†…å®¹ä¸ºç©ºï¼Œåªè¦æœ‰å­é¡µé¢å³å¯ï¼Œä½†é€šå¸¸éœ€è¦ä¸»å†…å®¹
    if(!srcMain && subPages.length === 0) return alert('è¯·è‡³å°‘å¡«å…¥ä¸»å†…å®¹æˆ–æ·»åŠ ä¸€ä¸ªå­é¡µé¢');
    
    // 1. åŠ å¯†ä¸»å†…å®¹ (Main Content) - ä½¿ç”¨ masterKey
    let encryptedMain = "";
    if(srcMain) {
        encryptedMain = CryptoJS.AES.encrypt(srcMain, masterKey).toString();
    }
    
    // 2. åŠ å¯†å­é¡µé¢ (Sub Pages) - ä½¿ç”¨å„è‡ªçš„å¯†ç 
    const encryptedSubPages = subPages.map(page => {
        return CryptoJS.AES.encrypt(page.html, page.pass).toString();
    });

    // 3. å‡†å¤‡é…ç½®
    const apiConfig = {
        enabled: document.getElementById('useApi').checked,
        url: document.getElementById('apiUrl').value,
        type: document.getElementById('apiType').value,
        path: document.getElementById('apiPath').value
    };
    
    let userHtml = editor.getValue() || defaultTemplate;
    
    // 4. æ„å»ºå†…æ ¸è„šæœ¬ (Core Loader)
    const coreScript = `
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"><\/script>
<script>
(function(){
    // æ•°æ®ç»“æ„ï¼šC_MAIN æ˜¯ä¸»å†…å®¹ï¼ŒC_SUBS æ˜¯å­å†…å®¹æ•°ç»„
    const C_MAIN = "${encryptedMain}";
    const C_SUBS = ${JSON.stringify(encryptedSubPages)};
    const V = ${JSON.stringify(vault.map(v=>v.lock))};
    const API = ${JSON.stringify(apiConfig)};
    
    window.LX = {
        config: { useApi: API.enabled },
        onMessage: function(msg, type){ console.log(type, msg); },
        
        // æ ¸å¿ƒè§£é”å…¥å£
        unlock: function(key) {
             if(!key) return this.onMessage('è¯·è¾“å…¥å¯†ç ', 'error');
             // ç­–ç•¥ï¼šå…ˆè¯•æœ¬åœ°Vault(ä¸»é¡µ)ï¼Œå†è¯•ç›´æ¥è§£å¯†SubPages
             tryDecodeAll(key);
        },
        
        unlockWithFile: function(file) {
            if(!file) return this.onMessage('è¯·é€‰æ‹©æ–‡ä»¶', 'error');
            const r = new FileReader();
            r.onload = e => {
                const hash = CryptoJS.SHA256(CryptoJS.lib.WordArray.create(e.target.result)).toString();
                // æ–‡ä»¶é”ç›®å‰åªè®¾è®¡ç”¨äºè§£é”ä¸»é¡µ (å­˜åœ¨ Vault ä¸­)
                tryUnlockMainWithKey(hash); 
            };
            r.readAsArrayBuffer(file);
        },
        
        unlockWithApi: async function(token) {
            if(!API.enabled) return this.onMessage('API æœªå¯ç”¨', 'error');
            if(!token) return this.onMessage('è¯·è¾“å…¥ Token', 'error');
            
            this.onMessage('æ­£åœ¨è¿æ¥éªŒè¯...', 'process');
            try {
                const url = API.url.replace('{KEY}', encodeURIComponent(token));
                const res = await fetch(url);
                if(!res.ok) throw new Error('API çŠ¶æ€ç  ' + res.status);
                
                let mk = '';
                if(API.type === 'json') {
                    const json = await res.json();
                    mk = API.path.split('.').reduce((o,i)=>o?o[i]:null, json);
                } else {
                    mk = await res.text();
                }
                
                if(!mk) throw new Error('è¿”å›æ•°æ®æ— æ•ˆ');
                // API è¿”å›çš„æ˜¯ MasterKeyï¼Œç›´æ¥è§£é”ä¸»é¡µ
                doFinalRender(C_MAIN, mk.trim(), 'APIéªŒè¯æˆåŠŸ');
                
            } catch(e) {
                this.onMessage('éªŒè¯å¤±è´¥: ' + e.message, 'error');
            }
        }
    };

    // å°è¯•æ‰€æœ‰å¯èƒ½çš„è§£é”è·¯å¾„
    function tryDecodeAll(inputPass) {
        // 1. å°è¯•ä½œä¸º MasterKey çš„ä¿æŠ¤å¯†ç  (è§£é”ä¸»é¡µ)
        if(tryUnlockMainWithKey(inputPass)) return;

        // 2. å°è¯•ä½œä¸ºå­é¡µé¢çš„ç›´æ¥å¯†ç 
        for(let i=0; i<C_SUBS.length; i++) {
            if(tryDecryptAndRender(C_SUBS[i], inputPass)) return;
        }

        window.LX.onMessage('å¯†ç é”™è¯¯', 'error');
    }

    // å°è¯•è§£é”ä¸»é¡µä¿é™©ç®±
    function tryUnlockMainWithKey(key) {
        if(!C_MAIN) return false; // æ²¡æœ‰ä¸»é¡µå†…å®¹
        let mk = null;
        for(let lock of V) {
            try {
                const bytes = CryptoJS.AES.decrypt(lock, key);
                const str = bytes.toString(CryptoJS.enc.Utf8);
                if(str.startsWith("OK|")) {
                    mk = str.split('|')[1];
                    break;
                }
            } catch(e) {}
        }
        if(mk) {
            return doFinalRender(C_MAIN, mk, 'ä¸»é¡µè§£é”æˆåŠŸ');
        }
        return false;
    }

    // é€šç”¨å°è¯•è§£å¯†æ¸²æŸ“ (è¿”å› bool)
    function tryDecryptAndRender(cipher, key) {
        try {
            const bytes = CryptoJS.AES.decrypt(cipher, key);
            const html = bytes.toString(CryptoJS.enc.Utf8);
            // ç®€å•çš„æ ¡éªŒ: å¿…é¡»åŒ…å« HTML æ ‡ç­¾
            if(html && html.includes('<')) {
                renderHtml(html);
                return true;
            }
        } catch(e) {}
        return false;
    }

    // æœ€ç»ˆæ¸²æŸ“é€»è¾‘ (å·²çŸ¥ key è‚¯å®šæ­£ç¡®æˆ–è€…æ˜¯ MasterKey)
    function doFinalRender(cipher, key, successMsg) {
        try {
            const bytes = CryptoJS.AES.decrypt(cipher, key);
            const html = bytes.toString(CryptoJS.enc.Utf8);
            if(!html || !html.includes('<')) throw new Error();
            renderHtml(html);
            return true;
        } catch(e) {
            window.LX.onMessage('è§£å¯†å¤±è´¥ (å¯èƒ½æ˜¯å¯†é’¥é”™è¯¯)', 'error');
            return false;
        }
    }

    function renderHtml(html) {
        document.open();
        document.write(html);
        document.close();
    }
})();
<\/script>`;

    let finalHtml = "";
    if(userHtml.includes('</body>')) {
        finalHtml = userHtml.replace('</body>', coreScript + '</body>');
    } else {
        finalHtml = userHtml + coreScript;
    }

    const blob = new Blob([finalHtml], {type: "text/html"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "index.html";
    a.click();
}

initKey();
</script>
</body>
</html>