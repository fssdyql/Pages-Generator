<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>é¡µé¢åŠ å¯†ç”Ÿæˆå™¨ (all)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
    body{font-family:"Segoe UI",Roboto,sans-serif;background:#f8fafc;color:#1e293b;max-width:900px;margin:20px auto;padding:20px}
    .card{background:#fff;border-radius:12px;padding:24px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);margin-bottom:20px;border:1px solid #e2e8f0}
    h2{margin-top:0;font-size:18px;border-bottom:1px solid #f1f5f9;padding-bottom:12px;color:#0f172a;display:flex;align-items:center;gap:10px}
    .badge{background:#3b82f6;color:#fff;font-size:12px;padding:2px 8px;border-radius:10px;font-weight:normal}
    textarea{width:100%;height:120px;font-family:monospace;padding:12px;border:1px solid #cbd5e1;border-radius:8px;font-size:13px;display:block;box-sizing:border-box}
    input[type="text"]{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:6px;box-sizing:border-box}
    .row{display:flex;gap:10px;margin-bottom:10px;align-items:center}
    button{padding:10px 18px;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:0.2s}
    button:hover{filter:brightness(0.95)}
    button.green{background:#10b981}
    button.red{background:#ef4444}
    button.gray{background:#64748b}
    
    .key-display{background:#ecfdf5;color:#047857;padding:15px;border-radius:8px;border:1px dashed #34d399;font-family:monospace;word-break:break-all;font-weight:bold;margin-bottom:15px}
    .sub-section{background:#f8fafc;padding:15px;border-radius:8px;border:1px solid #e2e8f0;margin-top:10px}
    .key-list{margin-top:10px}
    .key-item{background:#fff;padding:8px;border:1px solid #e2e8f0;border-radius:6px;margin-bottom:5px;display:flex;justify-content:space-between;font-size:14px}
</style>
</head>
<body>

<!-- 1. æ ¸å¿ƒå¯†é’¥ -->
<div class="card">
    <h2>1. ç³»ç»Ÿä¸»å¯†é’¥ <span class="badge">é‡è¦</span></h2>
    <p style="font-size:14px;color:#64748b">è¿™æ˜¯è§£å¼€ç½‘é¡µçš„å”¯ä¸€æ ¸å¿ƒé’¥åŒ™ã€‚æœ¬åœ°å¯†ç ä¼šåŠ å¯†å®ƒï¼Œ<b>API æ¥å£ä¹Ÿå¿…é¡»è¿”å›è¿™ä¸ªå€¼</b>ã€‚</p>
    <div class="key-display" id="masterKeyDisplay">ç”Ÿæˆä¸­...</div>
    <div class="row">
        <button class="green" onclick="genMasterKey()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
        <button class="gray" onclick="copyMasterKey()">ğŸ“‹ å¤åˆ¶ (ç”¨äºé…ç½®åç«¯)</button>
    </div>
</div>

<!-- 2. æºç  -->
<div class="card">
    <h2>2. åŸå§‹å†…å®¹ (HTML)</h2>
    <textarea id="srcHtml" placeholder="åœ¨æ­¤ç²˜è´´åŸæ¥çš„ LX æ’ä»¶ HTML ä»£ç ..."></textarea>
</div>

<!-- 3. é…ç½®è§£é”æ–¹å¼ -->
<div class="card">
    <h2>3. é…ç½®è§£é”æ–¹å¼</h2>
    
    <!-- æ–¹å¼A: API -->
    <div class="sub-section">
        <div style="font-weight:bold;margin-bottom:10px;color:#3b82f6">æ–¹å¼ A: è¿œç¨‹ API éªŒè¯</div>
        <div style="font-size:12px;color:#64748b;margin-bottom:8px">å¯ç”¨åï¼Œç”¨æˆ·è¾“å…¥Tokenï¼Œç½‘é¡µè¯·æ±‚APIã€‚è‹¥APIè¿”å›ä¸»å¯†é’¥ï¼Œåˆ™è§£é”ã€‚</div>
        <div class="row">
            <input type="checkbox" id="useApi" onchange="toggleApi(this.checked)"> <label for="useApi">å¯ç”¨ API éªŒè¯</label>
        </div>
        <div id="apiConfig" style="display:none">
            <label style="font-size:12px;display:block;margin-bottom:4px">API URL æ¨¡æ¿ ({KEY} ä¼šè¢«æ›¿æ¢ä¸ºç”¨æˆ·è¾“å…¥çš„å£ä»¤):</label>
            <input type="text" id="apiUrl" placeholder="https://api.example.com/check?token={KEY}" style="margin-bottom:10px">
            
            <label style="font-size:12px;display:block;margin-bottom:4px">è¿”å›æ ¼å¼:</label>
            <select id="apiType" style="padding:8px;border-radius:6px;border:1px solid #cbd5e1;width:100%;margin-bottom:10px">
                <option value="text">çº¯æ–‡æœ¬ (Body å°±æ˜¯ä¸»å¯†é’¥)</option>
                <option value="json">JSON (ä»å­—æ®µè¯»å–)</option>
            </select>
            <input type="text" id="apiJsonPath" placeholder="JSONå­—æ®µè·¯å¾„, å¦‚: data.key" style="display:none">
        </div>
    </div>

    <!-- æ–¹å¼B: æœ¬åœ°å¯†ç  -->
    <div class="sub-section">
        <div style="font-weight:bold;margin-bottom:10px;color:#8b5cf6">æ–¹å¼ B: æœ¬åœ°å¯†ç /å¯†é’¥</div>
        <div class="row">
            <input type="text" id="txtPass" placeholder="è¾“å…¥å¯†ç  (å¦‚ 123456)">
            <button onclick="addPass()">æ·»åŠ </button>
        </div>
    </div>

    <!-- æ–¹å¼C: æ–‡ä»¶é” -->
    <div class="sub-section">
        <div style="font-weight:bold;margin-bottom:10px;color:#ec4899">æ–¹å¼ C: æ–‡ä»¶é”</div>
        <div class="row">
            <input type="file" id="filePass">
            <button onclick="addFile()">æ·»åŠ æ–‡ä»¶</button>
        </div>
    </div>

    <div class="key-list" id="vaultList"></div>
</div>

<!-- 4. ç”Ÿæˆ -->
<div class="card">
    <h2>4. ç”Ÿæˆç¦»çº¿é¡µé¢</h2>
    <button onclick="generate()" style="width:100%;height:45px;font-size:16px">ğŸš€ ç”Ÿæˆ index.html ä»£ç </button>
    <textarea id="finalHtml" readonly placeholder="ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º..." style="height:200px;margin-top:15px"></textarea>
</div>

<script>
let masterKey = '';
let vault = []; // æœ¬åœ°é”åˆ—è¡¨

function genMasterKey() {
    masterKey = CryptoJS.lib.WordArray.random(32).toString();
    document.getElementById('masterKeyDisplay').innerText = masterKey;
    // é‡ç½®æœ¬åœ°é”ï¼Œå› ä¸ºä¸»å¯†é’¥å˜äº†ï¼Œæ—§é”å¤±æ•ˆ
    vault = [];
    renderVault();
}

function copyMasterKey() {
    navigator.clipboard.writeText(masterKey);
    alert('ä¸»å¯†é’¥å·²å¤åˆ¶ï¼è¯·ç¡®ä¿ä½ çš„ API æ¥å£ä¼šåœ¨éªŒè¯æˆåŠŸåè¿”å›è¿™ä¸ªå­—ç¬¦ä¸²ã€‚');
}

function toggleApi(show) {
    document.getElementById('apiConfig').style.display = show ? 'block' : 'none';
}

document.getElementById('apiType').addEventListener('change', function() {
    document.getElementById('apiJsonPath').style.display = this.value === 'json' ? 'block' : 'none';
});

// æ·»åŠ æœ¬åœ°å¯†ç 
function addPass() {
    const p = document.getElementById('txtPass').value;
    if(!p) return;
    // åˆ¶ä½œé”ï¼šç”¨å¯†ç åŠ å¯†(VerifyToken + MasterKey)
    const lock = CryptoJS.AES.encrypt("OK|" + masterKey, p).toString();
    vault.push({type: 'PASS', desc: p, lock: lock});
    document.getElementById('txtPass').value='';
    renderVault();
}

// æ·»åŠ æœ¬åœ°æ–‡ä»¶
function addFile() {
    const f = document.getElementById('filePass').files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        const hash = CryptoJS.SHA256(CryptoJS.lib.WordArray.create(e.target.result)).toString();
        const lock = CryptoJS.AES.encrypt("OK|" + masterKey, hash).toString();
        vault.push({type: 'FILE', desc: 'æ–‡ä»¶: ' + f.name, lock: lock});
        renderVault();
    };
    r.readAsArrayBuffer(f);
}

function renderVault() {
    document.getElementById('vaultList').innerHTML = vault.map((k,i) => `
        <div class="key-item">
            <span>[${k.type}] ${k.desc}</span>
            <button class="red" style="padding:2px 8px;font-size:12px" onclick="vault.splice(${i},1);renderVault()">åˆ </button>
        </div>
    `).join('');
}

function generate() {
    const src = document.getElementById('srcHtml').value;
    if(!src) return alert('è¯·ç²˜è´´æºç ');
    
    // 1. åŠ å¯†åŸå§‹å†…å®¹
    const encryptedContent = CryptoJS.AES.encrypt(src, masterKey).toString();
    
    // 2. æ”¶é›† API é…ç½®
    const useApi = document.getElementById('useApi').checked;
    const apiConfig = {
        enabled: useApi,
        url: document.getElementById('apiUrl').value,
        type: document.getElementById('apiType').value,
        path: document.getElementById('apiJsonPath').value
    };

    if(useApi && !apiConfig.url) return alert('è¯·å¡«å†™ API URL');
    if(!useApi && vault.length === 0) return alert('è‡³å°‘éœ€è¦ä¸€ç§è§£é”æ–¹å¼ï¼ˆAPI æˆ– æœ¬åœ°å¯†ç ï¼‰');

    // 3. ç”Ÿæˆ HTML
    const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restricted Access</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"><\/script>
<style>
body{background:#111;color:#eee;font-family:monospace;display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
.box{width:90%;max-width:400px;background:#222;padding:25px;border-radius:10px;border:1px solid #333;box-shadow:0 10px 20px rgba(0,0,0,0.5)}
.tabs{display:flex;border-bottom:1px solid #333;margin-bottom:20px}
.tab{flex:1;text-align:center;padding:10px;cursor:pointer;color:#666;transition:0.3s}
.tab.active{color:#3b82f6;border-bottom:2px solid #3b82f6}
.panel{display:none}
.panel.active{display:block}
input{width:100%;padding:12px;background:#000;border:1px solid #333;color:#fff;border-radius:5px;box-sizing:border-box;margin-bottom:15px;text-align:center;outline:none}
input:focus{border-color:#3b82f6}
button{width:100%;padding:12px;background:#3b82f6;color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:bold}
button:hover{background:#2563eb}
button:disabled{background:#444;cursor:wait}
.file-area{border:2px dashed #333;padding:20px;text-align:center;border-radius:5px;cursor:pointer;margin-bottom:15px}
.file-area:hover{border-color:#3b82f6;background:#111}
#msg{color:#f43f5e;text-align:center;margin-top:15px;font-size:12px;min-height:1.2em}
</style>
</head>
<body>
<div class="box" id="ui">
    <h3 style="text-align:center;margin-top:0;color:#fff">ğŸ” ACCESS CONTROL</h3>
    <div class="tabs">
        ${useApi ? '<div class="tab active" onclick="sw(0)">API éªŒè¯</div>' : ''}
        ${vault.length > 0 ? `<div class="tab ${!useApi?'active':''}" onclick="sw(1)">æœ¬åœ°å¯†é’¥</div>` : ''}
    </div>

    <!-- API Panel -->
    ${useApi ? `
    <div class="panel active" id="p0">
        <p style="font-size:12px;color:#888;text-align:center">è¾“å…¥æˆæƒç ä»¥è¿æ¥æœåŠ¡å™¨è·å–æƒé™</p>
        <input type="text" id="apiToken" placeholder="è¾“å…¥ Token / æˆæƒç " onkeyup="if(event.key==='Enter')doApi()">
        <button id="btnApi" onclick="doApi()">ğŸ”— è¿æ¥éªŒè¯</button>
    </div>` : ''}

    <!-- Local Panel -->
    ${vault.length > 0 ? `
    <div class="panel ${!useApi?'active':''}" id="p1">
        <p style="font-size:12px;color:#888;text-align:center">è¾“å…¥å¯†ç  æˆ– ä¸Šä¼ å¯†é’¥æ–‡ä»¶</p>
        
        <input type="password" id="locPass" placeholder="è¾“å…¥å¯†ç ..." onkeyup="if(event.key==='Enter')doLocal()">
        
        <div style="text-align:center;color:#444;margin-bottom:10px;font-size:12px">- OR -</div>
        
        <div class="file-area" onclick="document.getElementById('fIn').click()">
            <div id="fn">ğŸ“ ç‚¹å‡»ä¸Šä¼ å¯†é’¥æ–‡ä»¶</div>
        </div>
        <input type="file" id="fIn" style="display:none" onchange="handleF(this)">
        
        <button onclick="doLocal()">ğŸ”“ è§£é”</button>
    </div>` : ''}

    <div id="msg"></div>
</div>

<script>
const C = "${encryptedContent}";
const V = ${JSON.stringify(vault.map(v=>v.lock))};
const API = ${JSON.stringify(apiConfig)};
let fHash = null;

function sw(n){
    document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active', ${useApi ? 'i===n' : 'true'}));
    document.querySelectorAll('.panel').forEach((p,i)=>p.classList.toggle('active', ${useApi ? 'i===n' : 'true'}));
    msg('');
}

function msg(t){ document.getElementById('msg').innerText=t; }

function handleF(el){
    if(el.files[0]){
        document.getElementById('fn').innerText = "ğŸ“„ " + el.files[0].name;
        const r = new FileReader();
        r.onload = e => fHash = CryptoJS.SHA256(CryptoJS.lib.WordArray.create(e.target.result)).toString();
        r.readAsArrayBuffer(el.files[0]);
    }
}

// æ ¸å¿ƒè§£å¯†ä¸é‡å†™
function unlock(mk){
    try{
        const bytes = CryptoJS.AES.decrypt(C, mk);
        const html = bytes.toString(CryptoJS.enc.Utf8);
        if(!html) throw new Error();
        document.open();
        document.write(html);
        document.close();
    }catch(e){
        msg("å¯†é’¥æ ¡éªŒå¤±è´¥ (æ•°æ®æŸå)");
    }
}

// æœ¬åœ°è§£é”é€»è¾‘
function doLocal(){
    const p = document.getElementById('locPass') ? document.getElementById('locPass').value : '';
    const keysToCheck = [];
    if(p) keysToCheck.push(p);
    if(fHash) keysToCheck.push(fHash);
    
    if(keysToCheck.length===0) return msg("è¯·è¾“å…¥å¯†ç æˆ–é€‰æ‹©æ–‡ä»¶");

    let foundKey = null;
    // æš´åŠ›å°è¯•ï¼šæ‹¿ç”¨æˆ·è¾“å…¥çš„å¯†ç å»è¯•æ‰€æœ‰çš„é”
    for(let k of keysToCheck){
        for(let lock of V){
            try{
                const bytes = CryptoJS.AES.decrypt(lock, k);
                const str = bytes.toString(CryptoJS.enc.Utf8);
                if(str.startsWith("OK|")){
                    foundKey = str.split('|')[1];
                    break;
                }
            }catch(e){}
        }
        if(foundKey) break;
    }

    if(foundKey) unlock(foundKey);
    else msg("å¯†ç æˆ–æ–‡ä»¶é”™è¯¯");
}

// API è§£é”é€»è¾‘
async function doApi(){
    const token = document.getElementById('apiToken').value;
    if(!token) return msg("è¯·è¾“å…¥ Token");
    
    const btn = document.getElementById('btnApi');
    btn.disabled = true;
    btn.innerText = "â³ éªŒè¯ä¸­...";
    msg("");

    try {
        const url = API.url.replace('{KEY}', encodeURIComponent(token));
        const res = await fetch(url);
        if(!res.ok) throw new Error("API status " + res.status);
        
        let mk = "";
        if(API.type === 'json'){
            const data = await res.json();
            mk = API.path.split('.').reduce((o,i)=>o?o[i]:null, data);
        } else {
            mk = await res.text();
        }
        
        if(!mk) throw new Error("APIæœªè¿”å›å¯†é’¥");
        unlock(mk.trim());
        
    } catch(e) {
        console.error(e);
        msg("API éªŒè¯å¤±è´¥: " + e.message);
        btn.disabled = false;
        btn.innerText = "ğŸ”— è¿æ¥éªŒè¯";
    }
}
<\/script>
</body>
</html>`;

    document.getElementById('finalHtml').value = html;
}

// åˆå§‹åŒ–
genMasterKey();
</script>
</body>
</html>